using CheckSumTerminal.IModels;
using CheckSumTerminal.IView;
using CheckSumTerminal.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using static Microsoft.EntityFrameworkCore.DbLoggerCategory;

namespace CheckSumTerminal.Presenter
{
    internal class ShowChangesPresenter
    {
        private IShowChangesWindow _view;

        private IMainModel _model;

        public ShowChangesPresenter(IShowChangesWindow view, IMainModel model)
        {
            _view = view;
            _model = model;
            _view.comboChange += _view_comboChange;
            _view.load += _view_load;
        }

        private void _view_comboChange(object sender, EventArgs e)
        {
            string vers = _view.versionComboBox.SelectedItem.ToString();
            string versPrev = vers.Split(".")[0] +"."+ (int.Parse(vers.Split(".")[1])-1).ToString();
            var prevList = _model.getListFilesFromTable(Properties.Resources.VersionFolderName + @"\" + versPrev + @"\" + versPrev + ".csv");
            List<FileTableModel> curList;
            if (_view.versionComboBox.SelectedIndex != _view.versionComboBox.Items.Count - 1)
                curList = _model.getListFilesFromTable(Properties.Resources.VersionFolderName + @"\" + vers + @"\" + vers + ".csv");
            else
                curList = _model.getListFilesFromTable(Environment.CurrentDirectory + @"\" + Properties.Resources.CSVTableName);

            List<long> ids = new List<long>();
            //Создаем список измененных id

            //Если мы не дошли до самой первой версии
            if (prevList != null)
            {
                if (curList.Count >= prevList.Count)
                {
                    for (int i = 0; i < curList.Count; i++)
                    {
                        if (i >= prevList.Count || curList[i].version != prevList[i].version)
                            ids.Add(curList[i].id);
                    }
                }
                else
                {
                    for (int i = 0; i < prevList.Count; i++)
                    {
                        if (i >= curList.Count || curList[i].version != prevList[i].version)
                            ids.Add(prevList[i].id);
                    }
                }
                _view.prev.ItemsSource = prevList.Where(x => ids.Contains(x.id));
                _view.prevText.Text = versPrev;
            }
            else //Если это первая версия и предшественника не существует
            {
                ids = curList.Select(x => x.id).ToList();
                _view.prev.ItemsSource = null;
                _view.prevText.Text = "Отсутсвует";
            }

            _view.current.ItemsSource = curList.Where(x => ids.Contains(x.id));
            _view.currentText.Text = vers;
        }

        private void _view_load(object sender, EventArgs e)
        {
            var lst = _model.getVersionModels().Select(x=>x.Версия);
            _view.versionComboBox.ItemsSource = lst;
            _view.versionComboBox.SelectedIndex = _view.versionComboBox.Items.Count - 1;
        }
    }
}
